From f0c5cc79abc6ffec5806305b8371f75e68907d42 Mon Sep 17 00:00:00 2001
From: Andrej Gessel <andrej.gessel@husqvarnagroup.com>
Date: Tue, 23 Oct 2018 16:32:40 +0200
Subject: [PATCH] use new dtsi for soc, enable wmac, add spi partitions, set
 cpu device_type

Signed-off-by: Andrej Gessel <andrej.gessel@husqvarnagroup.com>
---
 .../dts/ralink/gardena_smart_gateway_mt7688.dts    | 86 +++++++++++++---------
 arch/mips/boot/dts/ralink/mt7628an.dtsi            |  1 +
 2 files changed, 54 insertions(+), 33 deletions(-)

diff --git a/arch/mips/boot/dts/ralink/gardena_smart_gateway_mt7688.dts b/arch/mips/boot/dts/ralink/gardena_smart_gateway_mt7688.dts
index 7f6f2bb07d20..7c8bf6412911 100644
--- a/arch/mips/boot/dts/ralink/gardena_smart_gateway_mt7688.dts
+++ b/arch/mips/boot/dts/ralink/gardena_smart_gateway_mt7688.dts
@@ -1,12 +1,12 @@
 /dts-v1/;
 
-/include/ "mt7628a.dtsi"
+/include/ "mt7628an.dtsi"
 
 #include <dt-bindings/gpio/gpio.h>
 #include <dt-bindings/input/input.h>
 
 / {
-	compatible = "Gardena,smartGatewayMT7688", "ralink,mt7688a-soc", "ralink,mt7628a-soc";
+	compatible = "Gardena,smartGatewayMT7688", "ralink,mt7628an-soc";
 	model = "Gardena smart Gateway MT7688";
 
 	memory@0 {
@@ -15,32 +15,34 @@
 	};
 
 	chosen {
-		stdout-path = &uart0;
+		bootargs = "console=ttyS0,115200";
+	};
+
+	aliases {
+		serial0 = &uartlite;
 	};
 };
 
 &pinctrl {
 	state_default: pinctrl0 {
 		gpio {
-			ralink,group = "gpio", "i2s", "p0led_an", "p1led_an", "p2led_an",
-			               "p3led_an", "p4led_an", "spis", "wled_an", "wdt", "sdmode",
-			               "refclk", "perst", "pwm0", "pwm1";
+			ralink,group = "gpio";
 			ralink,function = "gpio";
 		};
 
-		uart0 {
-			ralink,group = "uart0";
-			ralink,function = "uart0";
+		refclk {
+			ralink,group = "refclk";
+			ralink,function = "gpio";
 		};
 
-		uart1 {
-			ralink,group = "uart1";
-			ralink,function = "uart1";
+		spis {
+			ralink,group = "spis";
+			ralink,function = "gpio";
 		};
 
-		uart2 {
-			ralink,group = "uart2";
-			ralink,function = "uart2";
+		wdt {
+			ralink,group = "wdt";
+			ralink,function = "gpio";
 		};
 	};
 };
@@ -52,12 +54,38 @@
 	pinctrl-0 = <&spi_pins>, <&spi_cs1_pins>;
 
 	m25p80@0 {
-		#address-cells = <1>;
-		#size-cells = <1>;
 		compatible = "jedec,spi-nor";
 		reg = <0>;
 		spi-max-frequency = <40000000>;
 		m25p,chunked-io = <31>;
+
+		partitions {
+			compatible = "fixed-partitions";
+			#address-cells = <1>;
+			#size-cells = <1>;
+
+			partition@0 {
+				label = "uboot";
+				reg = <0x0 0xa0000>;
+				read-only;
+			};
+
+			partition@a0000 {
+				label = "uboot_env0";
+				reg = <0xa0000 0x10000>;
+			};
+
+			partition@b0000 {
+				label = "uboot_env1";
+				reg = <0xb0000 0x10000>;
+			};
+
+			factory: partition@c0000 {
+				label = "factory";
+				reg = <0xc0000 0x10000>;
+				read-only;
+			};
+		};
 	};
 
 	nand_flash@1 {
@@ -68,22 +96,6 @@
 	};
 };
 
-&gpio0 {
-	status = "okay";
-};
-
-&gpio1 {
-	status = "okay";
-};
-
-&gpio2 {
-	status = "okay";
-};
-
-&uart0 {
-	status = "okay";
-};
-
 &uart1 {
 	status = "okay";
 
@@ -98,3 +110,11 @@
 &i2c {
 	status = "okay";
 };
+
+&ethernet {
+	mtd-mac-address = <&factory 0x28>;
+};
+
+&wmac {
+	status = "okay";
+};
diff --git a/arch/mips/boot/dts/ralink/mt7628an.dtsi b/arch/mips/boot/dts/ralink/mt7628an.dtsi
index b8a8bb910334..235bad6cf560 100644
--- a/arch/mips/boot/dts/ralink/mt7628an.dtsi
+++ b/arch/mips/boot/dts/ralink/mt7628an.dtsi
@@ -9,6 +9,7 @@
 
 		cpu@0 {
 			compatible = "mips,mips24KEc";
+			device_type = "cpu";
 			reg = <0>;
 		};
 	};
-- 
2.11.0

